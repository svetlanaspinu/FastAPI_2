name: Build and Deploy Code # every process shoul have a name
# what trigers the code to run and branches
on: [push, pull_request]

#       Staring the CI - Continous Integration

jobs:
    job1:
        environment:
            name: testing
        env: # set up a job for env variable
          DATABASE_HOSTNAME: ${{secrets.DATABASE_HOSTNAME}} # inserat repositoriul secret
          DATABASE_PORT: ${{secrets.DATABASE_PORT}}
          DATABASE_PASSWORD: ${{secrets.DATABASE_PASSWORD}}
          DATABASE_NAME: ${{secrets.DATABASE_NAME}}
          DATABASE_USERNAME: ${{secrets.DATABASE_USERNAME}}
          SECRET_KEY: ${{secrets.SECRET_KEY}}
          ALGORITHM: ${{secrets.ALGORITHM}}
          ACCESS_TOKEN_EXPIRE_MINUTES: ${{secrets.ACCESS_TOKEN_EXPIRE_MINUTES}}

# connecting with postgresql
        services:
            postgres:
                image: postgres
                env:
                  POSTGRES_PASSWORD: ${{secrets.DATABASE_PASSWORD}}
                  POSTGRES_DB: ${{secrets.DATABASE_NAME}}_test # for testing
                ports:
                    - 5432:5432
                options: >- # https://docs.github.com/en/actions/using-containerized-services/creating-postgresql-service-containers
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        runs-on: windows-latest # specifying the OS
        steps:
            - name: pulling git repo # name of the actions
              uses: actions/checkout@v4 # commands from https://github.com/marketplace/actions/checkout example
            - uses: actions/setup-python@v5 #installing python
              with:
                python-version: '3.10' 
            - name: update pip
              run: python -m pip install --upgrade pip
            - name: install all dependencies #requiremnts.txt file
              run: pip install -r requirements.txt
            - name: test with pytest # to run pytest
            #to run multiple commands using | - at run command
              run: |
                pip install pytest 
                pytest


    